name: Deploy

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Write .env from secrets
        run: |
          cat <<'EOT' > .env
          APEX_HOST=${{ secrets.APEX_HOST }}
          WWW_HOST=${{ secrets.WWW_HOST }}
          EMAIL=${{ secrets.EMAIL }}
          HSTS_LINE=${{ secrets.HSTS_LINE }}
          ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}
          PERSIST_DIR=/data
          EOT
      - name: Verify environment
        run: ./scripts/check-env.sh
      - name: Run deploy script
        run: ./deploy.sh --build --pull
      - name: Run health checks
        run: ./scripts/health-check.sh
